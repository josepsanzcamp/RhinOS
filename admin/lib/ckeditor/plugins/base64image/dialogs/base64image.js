CKEDITOR.dialog.add("base64imageDialog",function(c){function t(b){if("string"==typeof b&&b){var e=new Image;f.getElement().setHtml("Loading...");e.onload=function(){f.getElement().setHtml("");null==k||null==h?(d.setValueOf("tab-properties","width",this.width),d.setValueOf("tab-properties","height",this.height),l=1,0<this.height&&0<this.width&&(l=this.width/this.height),0>=l&&(l=1)):h=k=null;this.id=c.id+"previewimage";this.setAttribute("style","max-width:400px;max-height:100px;");this.setAttribute("alt",
"");try{var b=f.getElement().$;b&&b.appendChild(this)}catch(e){}};e.onerror=function(){f.getElement().setHtml("")};e.onabort=function(){f.getElement().setHtml("")};e.src=b}else f.getElement().setHtml("")}function q(b){f.getElement().setHtml("");if("base64"==b)n&&n.setValue(!1,!0),p&&p.setValue(!1,!0);else if("url"==b)n&&n.setValue(!0,!0),p&&p.setValue(!1,!0),u&&t(u.getValue());else if(v){n&&n.setValue(!1,!0);p&&p.setValue(!0,!0);var e=d.getContentElement("tab-source","file");b=null;try{b=e.getInputElement().$}catch(a){b=
null}b&&"files"in b&&b.files&&0<b.files.length&&b.files[0]&&(!("type"in b.files[0])||b.files[0].type.match("image.*"))&&FileReader&&(f.getElement().setHtml("Loading..."),e=new FileReader,e.onload=function(b){return function(b){f.getElement().setHtml("");t(b.target.result)}}(b.files[0]),e.onerror=function(){f.getElement().setHtml("")},e.onabort=function(){f.getElement().setHtml("")},e.readAsDataURL(b.files[0]))}}function w(b){var e=d.getContentElement("tab-properties","width").getValue(),a=d.getContentElement("tab-properties",
"height").getValue(),c="px",g="px";0<=e.indexOf("%")&&(c="%");0<=a.indexOf("%")&&(g="%");e=parseInt(e,10);a=parseInt(a,10);isNaN(e)&&(e=0);isNaN(a)&&(a=0);var f="px";"width"==b?("%"==c&&(f="%"),a=Math.round(e/l)):("%"==g&&(f="%"),e=Math.round(a*l));"%"==f&&(e+="%",a+="%");d.getContentElement("tab-properties","width").setValue(e);d.getContentElement("tab-properties","height").setValue(a)}function x(b){var a=b.getValue(),c="";0<=a.indexOf("%")&&(c="%");a=parseInt(a,10);isNaN(a)&&(a=0);b.setValue(a+
c)}var d=null,a=null,k=null,h=null,f=null,n=null,u=null,p=null,l=1,r=!0,v=function(){var a=!1,c=null;try{FileReader&&(c=document.createElement("input"))&&"files"in c&&(a=!0)}catch(d){a=!1}return a}(),y=v?[{type:"hbox",widths:["70px"],children:[{type:"checkbox",id:"urlcheckbox",style:"margin-top:5px",label:c.lang.common.url+":"},{type:"text",id:"url",label:"",onChange:function(){q("url")}}]},{type:"hbox",widths:["70px"],children:[{type:"checkbox",id:"filecheckbox",style:"margin-top:5px",label:c.lang.common.upload+
":"},{type:"file",id:"file",label:"",onChange:function(){q("file")}}]},{type:"html",id:"preview",html:(new CKEDITOR.template('\x3cdiv style\x3d"text-align:center;"\x3e\x3c/div\x3e')).output()}]:[{type:"text",id:"url",label:c.lang.common.url,onChange:function(){q("url")}},{type:"html",id:"preview",html:(new CKEDITOR.template('\x3cdiv style\x3d"text-align:center;"\x3e\x3c/div\x3e')).output()}];return{title:c.lang.common.image,minWidth:450,minHeight:180,onLoad:function(){v&&(n=this.getContentElement("tab-source",
"urlcheckbox"),p=this.getContentElement("tab-source","filecheckbox"),n.getInputElement().on("click",function(){q("url")}),p.getInputElement().on("click",function(){q("file")}));u=this.getContentElement("tab-source","url");f=this.getContentElement("tab-source","preview");this.getContentElement("tab-properties","lock").getInputElement().on("click",function(){(r=this.getValue()?!0:!1)&&w("width")},this.getContentElement("tab-properties","lock"));this.getContentElement("tab-properties","width").getInputElement().on("keyup",
function(){r&&w("width")});this.getContentElement("tab-properties","height").getInputElement().on("keyup",function(){r&&w("height")});this.getContentElement("tab-properties","vmargin").getInputElement().on("keyup",function(){x(this)},this.getContentElement("tab-properties","vmargin"));this.getContentElement("tab-properties","hmargin").getInputElement().on("keyup",function(){x(this)},this.getContentElement("tab-properties","hmargin"));this.getContentElement("tab-properties","border").getInputElement().on("keyup",
function(){x(this)},this.getContentElement("tab-properties","border"))},onShow:function(){f.getElement().setHtml("");d=this;h=k=null;l=1;r=!0;(a=c.getSelection())&&(a=a.getSelectedElement());a&&"img"===a.getName()||(a=null);d.setValueOf("tab-properties","lock",r);d.setValueOf("tab-properties","vmargin","0");d.setValueOf("tab-properties","hmargin","0");d.setValueOf("tab-properties","border","0");d.setValueOf("tab-properties","align","none");if(a){"string"==typeof a.getAttribute("width")&&(k=a.getAttribute("width"));
"string"==typeof a.getAttribute("height")&&(h=a.getAttribute("height"));null!=k&&null!=h||!a.$||(k=a.$.width,h=a.$.height);null!=k&&null!=h&&(d.setValueOf("tab-properties","width",k),d.setValueOf("tab-properties","height",h),k=parseInt(k,10),h=parseInt(h,10),l=1,!isNaN(k)&&!isNaN(h)&&0<h&&0<k&&(l=k/h),0>=l&&(l=1));"string"==typeof a.getAttribute("src")&&(0===a.getAttribute("src").indexOf("data:")?(q("base64"),t(a.getAttribute("src"))):d.setValueOf("tab-source","url",a.getAttribute("src")));"string"==
typeof a.getAttribute("alt")&&d.setValueOf("tab-properties","alt",a.getAttribute("alt"));"string"==typeof a.getAttribute("hspace")&&d.setValueOf("tab-properties","hmargin",a.getAttribute("hspace"));"string"==typeof a.getAttribute("vspace")&&d.setValueOf("tab-properties","vmargin",a.getAttribute("vspace"));"string"==typeof a.getAttribute("border")&&d.setValueOf("tab-properties","border",a.getAttribute("border"));if("string"==typeof a.getAttribute("align"))switch(a.getAttribute("align")){case "top":case "text-top":d.setValueOf("tab-properties",
"align","top");break;case "baseline":case "bottom":case "text-bottom":d.setValueOf("tab-properties","align","bottom");break;case "left":d.setValueOf("tab-properties","align","left");break;case "right":d.setValueOf("tab-properties","align","right")}d.selectPage("tab-properties")}},onOk:function(){var b="";try{b=CKEDITOR.document.getById(c.id+"previewimage").$.src}catch(e){b=""}if("string"==typeof b&&null!=b&&""!==b){var f=a?a:c.document.createElement("img");f.setAttribute("src",b);f.setAttribute("alt",
d.getValueOf("tab-properties","alt").replace(/^\s+/,"").replace(/\s+$/,""));var b={width:["width","width:#;","integer",1],height:["height","height:#;","integer",1],vmargin:["vspace","margin-top:#;margin-bottom:#;","integer",0],hmargin:["hspace","margin-left:#;margin-right:#;","integer",0],align:["align",""],border:["border","border:# solid black;","integer",0]},k=[],g,h,l,m;for(m in b){h=l=g=d.getValueOf("tab-properties",m);unit="px";if("align"==m)switch(g){case "top":case "bottom":b[m][1]="vertical-align:#;";
break;case "left":case "right":b[m][1]="float:#;";break;default:g=null}"integer"==b[m][2]&&(0<=g.indexOf("%")&&(unit="%"),g=parseInt(g,10),isNaN(g)?g=null:g<b[m][3]&&(g=null),null!=g&&("%"==unit?(l=g+"%",h=g+"%"):(l=g,h=g+"px")));null!=g&&(f.setAttribute(b[m][0],l),k.push(b[m][1].replace(/#/g,h)))}0<k.length&&f.setAttribute("style",k.join(""));a||c.insertElement(f);c.plugins.imageresize&&c.plugins.imageresize.resize(c,f,800,800)}},contents:[{id:"tab-source",label:c.lang.common.generalTab,elements:y},
{id:"tab-properties",label:c.lang.common.advancedTab,elements:[{type:"text",id:"alt",label:c.lang.base64image.alt},{type:"hbox",widths:["15%","15%","70%"],children:[{type:"text",width:"45px",id:"width",label:c.lang.common.width},{type:"text",width:"45px",id:"height",label:c.lang.common.height},{type:"checkbox",id:"lock",label:c.lang.base64image.lockRatio,style:"margin-top:18px;"}]},{type:"hbox",widths:["23%","30%","30%","17%"],style:"margin-top:10px;",children:[{type:"select",id:"align",label:c.lang.common.align,
items:[[c.lang.common.notSet,"none"],[c.lang.common.alignTop,"top"],[c.lang.common.alignBottom,"bottom"],[c.lang.common.alignLeft,"left"],[c.lang.common.alignRight,"right"]]},{type:"text",width:"45px",id:"vmargin",label:c.lang.base64image.vSpace},{type:"text",width:"45px",id:"hmargin",label:c.lang.base64image.hSpace},{type:"text",width:"45px",id:"border",label:c.lang.base64image.border}]}]}]}});